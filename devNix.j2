{% set perPackageManager = {
    "npm": {
        "packages": "pkgs.nodejs_20",
        "install": "if [ -f package-lock.json ]; then npm ci --prefer-offline --no-audit --no-progress; else npm install --prefer-offline --no-audit --no-progress; fi",
				"android": "npm run android",
				"start": "\"npm\" \"run\" \"start\""
    },
    "yarn": {
        "packages": "pkgs.yarn",
        "install": "yarn install --frozen-lockfile",
				"previewAndroidPrefix": "yarn android",
				"start": "yarn start"
    }
}[packageManager]%}
{ pkgs, ... }: {
  config = {
    channel = "stable-23.11";
    
    env.NIXPKGS_ACCEPT_ANDROID_SDK_LICENSE = "1";
    
    packages = [
      {{perPackageManager.packages}}
      pkgs.jdk21_headless
      pkgs.gradle
      pkgs.socat
      pkgs.android-tools
      pkgs.watchman
      (pkgs.androidenv.composeAndroidPackages {
        buildToolsVersions = ["30.0.3"];
        platformVersions = ["30"];
        abiVersions = ["armeabi-v7a" "arm64-v8a" "x86" "x86_64"];
        includeNDK = false;  # We're adding NDK separately
        includeEmulator = true;
        includeSources = false;
        includeSystemImages = false;
        useGoogleAPIs = false;
      }).androidsdk
      pkgs.androidenv.androidndk_25
    ];
    
    env.ANDROID_NDK_ROOT = "${pkgs.androidenv.androidndk_25}";
    env.ANDROID_SDK_ROOT = "${(pkgs.androidenv.composeAndroidPackages {
        buildToolsVersions = ["30.0.3"];
        platformVersions = ["30"];
        abiVersions = ["armeabi-v7a" "arm64-v8a" "x86" "x86_64"];
        includeNDK = false;
        includeEmulator = true;
        includeSources = false;
        includeSystemImages = false;
        useGoogleAPIs = false;
      }).androidsdk}/libexec/android-sdk";
    
    idx = {
      extensions = [
        "msjsdiag.vscode-react-native"
        "dbaeumer.vscode-eslint"
        "esbenp.prettier-vscode"
      ];
      workspace = {
        onCreate = {
          install = ''
            # Install dependencies
            {{perPackageManager.install}}

            unset ANDROID_SDK_ROOT

            # Add more memory to the JVM
            sed -i 's/org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m/org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m/' "android/gradle.properties"
          '';
        };
        onStart = {
          forward-ports = ''
            socat -d -d TCP-LISTEN:5554,reuseaddr,fork TCP:$(cat /etc/resolv.conf | tail -n1 | cut -d " " -f 2):5554
          '';
          
          connect-device = ''
            # Wait for the emulator to be ready
            adb -s localhost:5554 wait-for-device 
          '';

          android = ''
            unset ANDROID_SDK_ROOT

            # GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.configureondemand=true" {{perPackageManager.android}}
            {{perPackageManager.android}}
          '';
        };
      };
      previews = {
        enable = true;
        previews = {
          web = {
            command = [{{perPackageManager.start}}];
            manager = "web";
          };
          android = {
            command = ["tail" "-f" "/dev/null"];
            manager = "web";
          };
        };
      };
    };
  };
}
